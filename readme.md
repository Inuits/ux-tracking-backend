# UX Tracking Backend

The Ux Tracking backend is written in [Flask-Restful](https://github.com/flask-restful/flask-restful/). This is a python based micro-framework.

There are 3 endpoints available in this API:

- [Auth](#endpointAuth)
- [Action](#endpointAction)
- [Error](#endpointError)

<span id="endpointAuth"></span>
#### /Auth
To authenticate, ux tracking uses JWT. In order to receive a valid token make the following request
```
POST /auth 
{
    "name": "{{ ApplicationName }}",
    "key": "{{ ApplicationKey }}"
}
```

This will provide a response
```json
{
  "access_token": "{{ jwt_token }}"
}
```

In order to access the other endpoints, you will need to provide a valid token in your `Authorization` header.
```
"Authorzation:Bearer {{ jwt_token }}"
```
<span id="endpointAction"></span>
#### /Action
An action consists of the following model

| Name | Type | Example |
| ---  | --- | --- |
| client | str| sportoffice |
| id | str| adsdfoiuvhwlkqjewr |
| method | str| REQ |
| path | str| /pos.html |
| position | str| 12,21 |
| session | str| admin |
| type | str| GET |
| value | str| {"This is where": "the response would be"} |


##### GET  
The GET returns a response containing all actions. There are some options to limit the output.  

- Limit  
You can implement 'paging' by passing `limit` and `from` as Query Parameters to the request.
```
/action?limit=10&from=0
```

- Filter  
You can add filters on all items defined above. Simply include them as Query Parameter.  
If you need to filter mutliple values of the same type, separate them with a `,`. To Exclude a certain value
add a prefix: `!`.

If you would like to fetch all the `click` and `focusout` actions but not generated by `projectX` or `projectY`:
```
/action?method=click,focusout&client=!projectX,!projectY
```

For using wildcard filters simply add `*` to whatever query you want.  
To get all actions from sessions that start with adm:
```
/action?session=adm*
```

**TODO**
We should implement a time range as well, as for now, it's only possible by passing a wildcard of timestamp.

##### POST
When posting to this endpoint, you don't have to pass the ID, it gets autogenerated by ES.
```
POST /action
{
 "actions": [
   {
      "client": "projectX",
      "session": "admin",
      "type": "REQ",
      "method": "GET",
      "value": "{{ response of request }}",
      timestamp: 123456789
   },{
     ..
   }
 ]
}
```

<span id="endpointError"></span>
#### /Error
The error model looks like the following:

|   Name     |      Type    | Example |
|   ---      |      ---     | --- |
| client 	 |  str			| projectX |
| session 	 |  str			| admin |
| error 	 |  str			|  404 Not Found |
| source 	 |  str			|  /pos.html |
| position 	 |  str			| 12,21 |
| stack 	 |  str			|  {{ stacktrace }} |
| actions 	 |  str			|  "{{ actionsJsonArray }}" |
| timestamp  |  int			| 987654321 |

##### GET
Simply returns all the errors.

###### POST
Simply adds an error


#### Installation
Ux Tracking backend has some dependencies.

| Dependency | Version | Description |
| --         | --      | --          |
| [flask](http://flask.pocoo.org/) | 1.0 | Basic Flask Framework|
| [flask-restful](https://github.com/flask-restful/flask-restful/) | 0.3.6 | Restful expansion of flask framework |
| [Flask-JWT-Extended](http://flask-jwt-extended.readthedocs.io/en/latest/) | 3.8.2 | JWT for Flask |
| ~~Flask-YAMLConfig~~ | 0.0.3 | Not needed anymore ? |
| [elasticsearch](https://elasticsearch-py.readthedocs.io/en/master/) | 6.2.0 | Elasticsearch Bridge |
| [pyOpenSSL](https://pyopenssl.org/en/stable/) | 18.0.0 | SSL for serving over https |
| [pytest](https://docs.pytest.org/en/latest/) | 3.6.0 | For testing |

These requirements are stored in requirements.txt, an easy install of the dependencies should be as follows:

```
pip install -r requirements.txt
```

#### Running the backend
To run the backend localhost for development, use the included `run.py`
```
python run.py
```

Default `WerkZeug` hosting port is `:5000`

#### Running tests
To run the tests, you should use pytest. The tests are included under `tests`
```
tests
├── es_options_test.py
├── __init__.py
├── integration
│   ├── action_test.py
│   ├── auth_test.py
│   ├── error_test.py
│   └── __init__.py 
└── integration_case.py
```

`es_options_test.py` is a unittest for our common/EsOptions class, which holds all the parameters for an 
ES call.

Everything under `integration` are basic integration tests.

Several options to run:
- Just run the tests
```
pytest # use -v for extra output
```

- Run with Coverage report
```
pytest --cov=.
```

- Run with Coverage report and create html of the result
```
pytest --cov=. --cov-report=html
```

Our coverage as of commit `77f53aee2e174e32e8a1d198bdfe2db5eaa93a72` (6-6-2018)
```
Name                               Stmts   Miss  Cover
------------------------------------------------------
app.py                                22      0   100%
common/__init__.py                     0      0   100%
common/es_options.py                  47      0   100%
resources/__init__.py                  0      0   100%
resources/action.py                   35      2    94%
resources/auth.py                     20      0   100%
resources/error.py                    36      0   100%
resources/ux_resource.py              14      0   100%
run.py                                 7      7     0%
tests/__init__.py                      0      0   100%
tests/es_options_test.py              85      0   100%
tests/integration/__init__.py          0      0   100%
tests/integration/action_test.py      10      0   100%
tests/integration/auth_test.py        15      0   100%
tests/integration/error_test.py       14      0   100%
tests/integration_case.py             18      0   100%
------------------------------------------------------
TOTAL                                323      9    97%
```
